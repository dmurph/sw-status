<link href="../paper-fab/paper-fab.html" rel="import">
<link href="../core-icons/core-icons.html" rel="import">
<link href="../paper-shadow/paper-shadow.html" rel="import">

<!--
Element that displays the ServiceWorker status for this page.  Currently it displays whether the page is controlled or not, and the registration for the ServiceWorker that can control this page.  In the future this can enumerate the info for all ServiceWorkers under the current domain.
##### Example
    <sw-status-element></sw-status-element>
@element sw-status-element
@blurb Element showing ServiceWorker status.
@status beta
@homepage http://dmurph.github.io/sw-status-element
-->
<polymer-element name="sw-status-element">
  <template>
    <link rel="stylesheet" href="sw-status-element.css">
    <paper-shadow z="1">
      <div id="container">
        <div id="title" class="{{titleStyle}}">
          <paper-fab id="refresh-button" icon="refresh" mini on-click="{{refreshClicked}}"></paper-fab>
          <span>{{controlledText}}</span>
        </div>
        <template repeat="{{registration in registrations}}">
          <div class="tabs">
            <paper-shadow class="tab {{registration.registrationClass}}" hidden?="{{registration.registrationText == null}}">
              <h1>Registration</h1>
              <template repeat="{{text in registration.registrationText}}">
                <p>{{text}}</p>
              </template>
            </paper-shadow>
            <paper-shadow class="tab installing" hidden?="{{registration.installingText == null}}">
              <h1>Installing Service Worker</h1>
              <template repeat="{{text in registration.installingText}}">
                <p>{{text}}</p>
              </template>
            </paper-shadow>
            <paper-shadow class="tab waiting" hidden?="{{registration.waitingText == null}}">
              <h1>Waiting Service Worker</h1>
              <template repeat="{{text in registration.waitingText}}">
                <p>{{text}}</p>
              </template>
            </paper-shadow>
            <paper-shadow class="tab active" hidden?="{{registration.activeText == null}}">
              <h1>Active Service Worker</h1>
              <template repeat="{{text in registration.activeText}}">
                <p>{{text}}</p>
              </template>
            </paper-shadow>
            <paper-shadow class="tab error" hidden?="{{(registration.errorText == null)}}">
              <h1>Error</h1>
              <template repeat="{{text in registration.errorText}}">
                <p>{{text}}</p>
              </template>
            </paper-shadow>
          </div>
        </template>
        <div class="tabs" hidden?="{{(errorText == null)}}">
          <paper-shadow class="tab error">
            <h1>Error</h1>
            <template repeat="{{text in errorText}}">
              <p>{{text}}</p>
            </template>
          </paper-shadow>
        </div>
        <div style="clear: left"></div>
      </div>
    </paper-shadow>
  </template>
  <script>

    Polymer({
      titleStyle: 'badText',
      controlledText: 'Not Controlled',

      registrations: [],

      onlyErrorText: false,
      errorText: null,

      ready: function() {
        this.refreshAll();
      },

      getServiceWorkerDescription: function(worker) {
        return ['Script: ' + worker.scriptURL, 'State: ' + worker.state];
      },

      refreshAll: function() {
        this.registrations = [];
        this.errorText = null;
        this.onlyErrorText = false;
        if (!navigator.serviceWorker) {
          this.errorText = ['Service Workers are not enabled in this browser.'];
          this.onlyErrorText = true;
          return;
        }
        var controller = navigator.serviceWorker.controller;
        if (controller) {
          this.controlledText = 'Controlled';
          this.titleStyle = 'goodText';
        }
        var _this = this;
        navigator.serviceWorker.getRegistration(window.location.pathname)
            .then(function(registration) {
              var registrationObject = {
                registrationText: null,
                installingText: null,
                waitingText: null,
                activeText: null,
                errorText: null,
                registrationClass: null
              };
              if (!registration) {
                _this.errorText = ['No registration available to control page "' + window.location.pathname + '".'];
                // We are still controlled, but the SW is unregistered.
                if (controller) {
                  registrationObject.registrationText = ['No registration, but this page is still controlled.'];
                  registrationObject.registrationClass = 'error';
                  registrationObject.activeText = _this.getServiceWorkerDescription(controller);
                }
                _this.registrations.push(registrationObject);
                return;
              }
              registrationObject.registrationText = ['Scope: ' + registration.scope];

              var worker = null;
              if (registration.installing) {
                registrationObject.installingText = _this.getServiceWorkerDescription(registration.installing);
              } else if (registration.waiting) {
                registrationObject.waitingText = _this.getServiceWorkerDescription(registration.waiting);
              } else if (registration.active) {
                registrationObject.activeText = _this.getServiceWorkerDescription(registration.active);
              } else {
                registrationObject.errorText = ['No registration found.'];
              }
              _this.registrations.push(registrationObject);
            }, function(why) {
                _this.errorText = ['Error getting registration for path "' + window.location.pathname + '": ' + why];
                _this.onlyErrorText = false;
            });
      },

      refreshClicked: function(event, detail, sender) {
        this.refreshAll();
      }
    });
  </script>
</polymer-element>
