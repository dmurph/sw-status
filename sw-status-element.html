<link rel="import" href="../paper-fab/paper-fab.html">
<link href="../core-icons/core-icons.html" rel="import">
<link href="../paper-shadow/paper-shadow.html" rel="import">
<polymer-element name="sw-status-element" attributes="author">

  <template>

    <link rel="stylesheet" href="sw-status-element.css">
    <paper-shadow z="1">
      <div id="container">
        <div id="title" class="{{titleStyle}}">
          <h1>{{controlledText}}</h1>
        </div>

        <template repeat="{{registration in registrations}}">
          <div class="tabs" hidden?="{{registration.onlyErrorText}}">
            <span class="tab">
              <h1>Registration</h1>
              <p>{{registration.registrationText}}</p>
            </span>
            <span class="tab installing" hidden?="{{registration.installingWorkerText != null}}">
              <h1>Installing Service Worker</h1>
              <p>{{registration.installingWorkerText}}</p>
            </span>
            <span class="tab waiting" hidden?="{{registration.waitingWorkerText != null}}">
              <h1>Waiting Service Worker</h1>
              <p>{{registration.waitingWorkerText}}</p>
            </span>
            <span class="tab active" hidden?="{{registration.activeWorkerText != null}}">
              <h1>Active Service Worker</h1>
              <p>{{registration.activeWorkerText}}</p>
            </span>
            <span class="tab error" hidden?="{{(registration.errorText == null)}}">
              <h1>Error</h1>
              <p>{{registration.errorText}}</p>
            </span>
          </div>
        </template>
        <div class="tabs">
          <span class="tab error" hidden?="{{(errorText == null)}}">
            <h1>Error</h1>
            <p>{{errorText}}</p>
          </span>
        </div>
        
        <paper-fab icon="refresh" mini></paper-fab>
        <div style="clear: left" ></div>
      </div>
    </paper-shadow>
  </template>
  <script>

    Polymer({
      author: 'Daniel Murphy',
      titleStyle: 'badText',
      controlledText: 'Not Controlled',

      registrations: [],

      onlyErrorText: false,
      errorText: null,

      ready: function() {
        this.refreshAll();
      },

      getServiceWorkerDescription: function(worker) {
        return "script: " + worker.scriptURL + "\nstate: " + worker.state;
      },

      refreshAll: function() {
        this.registrations = [];
        if (!navigator.serviceWorker) {
          this.errorText = 'Service Workers are not enabled in this browser.';
          this.onlyErrorText = true;
          return;
        }
        if (navigator.serviceWorker.controller) {
          this.controlledText = "Controlled";
          this.titleStyle = 'goodText';
        }
        var _this = this;
        navigator.serviceWorker.getRegistration(window.location.pathname)
            .then(function(registration) {
              if (!registration) {
                _this.errorText = 'No registration controlling page "' + window.location.pathname + '".';
                _this.onlyErrorText = true;
                return;
              }
              var registrationObject = {
                registrationText: null,
                installingWorkerText: null,
                waitingWorkerText: null,
                activeWorkerText: null,
                errorText: null,
              };
              registrationObject.registrationText = "Scope: " + registration.scope;

              var worker = null;
              if (registration.waiting) {
                registrationObject.waitingWorkerText = _this.getServiceWorkerDescription(registration.waiting);
              } else if (registration.installing) {
                registrationObject.installingWorkerText = _this.getServiceWorkerDescription(registration.installing);
              } else if (registration.active) {
                registrationObject.activeWorkerText = _this.getServiceWorkerDescription(registration.active);
              } else {
                registrationObject.errorText = 'No registration found.';
              }
              _this.registrations.push(registration);
            }, function(why) {
                _this.errorText = 'Error getting registration for path "' + window.location.pathname + '": ' + why;
                _this.onlyErrorText = false;
            });
      }
    });

  </script>
</polymer-element>
