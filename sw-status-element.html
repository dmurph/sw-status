<link href="../paper-fab/paper-fab.html" rel="import">
<link href="../core-icons/core-icons.html" rel="import">
<link href="../paper-shadow/paper-shadow.html" rel="import">

<polymer-element name="sw-status-element">
  <template>
    <link rel="stylesheet" href="sw-status-element.css">
    <paper-shadow z="1">
      <div id="container">
        <div id="title" class="{{titleStyle}}">
          <paper-fab id="refresh-button" icon="refresh" mini on-click="{{refreshClicked}}"></paper-fab>
          <span>{{controlledText}}</span>
        </div>
        <template repeat="{{registration in registrations}}">
          <div class="tabs">
            <paper-shadow class="tab">
              <h1>Registration</h1>
              <p>{{registration.registrationText}}</p>
            </paper-shadow>
            <paper-shadow class="tab installing" hidden?="{{registration.installingText == null}}">
              <h1>Installing Service Worker</h1>
              <p>{{registration.installingText}}</p>
            </paper-shadow>
            <paper-shadow class="tab waiting" hidden?="{{registration.waitingText == null}}">
              <h1>Waiting Service Worker</h1>
              <p>{{registration.waitingText}}</p>
            </paper-shadow>
            <paper-shadow class="tab active" hidden?="{{registration.activeText == null}}">
              <h1>Active Service Worker</h1>
              <p>{{registration.activeText}}</p>
            </paper-shadow>
            <paper-shadow class="tab error" hidden?="{{(registration.errorText == null)}}">
              <h1>Error</h1>
              <p>{{registration.errorText}}</p>
            </paper-shadow>
          </div>
        </template>
        <div class="tabs" hidden?="{{(errorText == null)}}">
          <paper-shadow class="tab error">
            <h1>Error</h1>
            <p>{{errorText}}</p>
          </paper-shadow>
        </div>
        <div style="clear: left"></div>
      </div>
    </paper-shadow>
  </template>
  <script>

    Polymer({
      titleStyle: 'badText',
      controlledText: 'Not Controlled',

      registrations: [],

      onlyErrorText: false,
      errorText: null,

      ready: function() {
        this.refreshAll();
      },

      getServiceWorkerDescription: function(worker) {
        return "script: " + worker.scriptURL + "\nstate: " + worker.state;
      },

      refreshAll: function() {
        this.registrations = [];
        this.errorText = null;
        this.onlyErrorText = false;
        if (!navigator.serviceWorker) {
          this.errorText = 'Service Workers are not enabled in this browser.';
          this.onlyErrorText = true;
          return;
        }
        if (navigator.serviceWorker.controller) {
          this.controlledText = "Controlled";
          this.titleStyle = 'goodText';
        }
        var _this = this;
        navigator.serviceWorker.getRegistration(window.location.pathname)
            .then(function(registration) {
              if (!registration) {
                _this.errorText = 'No registration controlling page "' + window.location.pathname + '".';
                _this.onlyErrorText = true;
                return;
              }
              var registrationObject = {
                registrationText: null,
                installingText: null,
                waitingText: null,
                activeText: null,
                errorText: null,
              };
              registrationObject.registrationText = "Scope: " + registration.scope;

              var worker = null;
              if (registration.waiting) {
                registrationObject.waitingText = _this.getServiceWorkerDescription(registration.waiting);
              } else if (registration.installing) {
                registrationObject.installingText = _this.getServiceWorkerDescription(registration.installing);
              } else if (registration.active) {
                registrationObject.activeText = _this.getServiceWorkerDescription(registration.active);
              } else {
                registrationObject.errorText = 'No registration found.';
              }
              _this.registrations.push(registrationObject);
            }, function(why) {
                _this.errorText = 'Error getting registration for path "' + window.location.pathname + '": ' + why;
                _this.onlyErrorText = false;
            });
      },

      refreshClicked: function(event, detail, sender) {
        this.refreshAll();
      }
    });

  </script>
</polymer-element>
